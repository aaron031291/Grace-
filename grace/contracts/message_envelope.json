{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Grace Message Envelope (GME)",
  "description": "Standard message envelope for all Grace events with tracing and idempotency support",
  "type": "object",
  "properties": {
    "msg_id": {
      "type": "string",
      "pattern": "^msg_[a-z0-9]{8,}$",
      "description": "Unique message identifier"
    },
    "headers": {
      "type": "object",
      "properties": {
        "traceparent": {
          "type": "string",
          "pattern": "^[0-9a-f]{2}-[0-9a-f]{32}-[0-9a-f]{16}-[0-9a-f]{2}$",
          "description": "W3C trace context parent header"
        },
        "tracestate": {
          "type": "string",
          "description": "W3C trace context state header"
        },
        "source": {
          "type": "string",
          "description": "Source component that created this message"
        },
        "event_type": {
          "type": "string",
          "enum": [
            "GOVERNANCE_VALIDATION",
            "GOVERNANCE_APPROVED", 
            "GOVERNANCE_REJECTED",
            "GOVERNANCE_NEEDS_REVIEW",
            "GOVERNANCE_ROLLBACK",
            "ORCHESTRATION_TASK_CREATED",
            "ORCHESTRATION_TASK_COMPLETED",
            "ORCHESTRATION_TASK_FAILED",
            "MEMORY_WRITE_REQUESTED",
            "MEMORY_WRITE_COMPLETED", 
            "MEMORY_READ_REQUESTED",
            "MEMORY_READ_COMPLETED",
            "RESILIENCE_INCIDENT_OPENED",
            "RESILIENCE_INCIDENT_RESOLVED",
            "RESILIENCE_CIRCUIT_OPENED",
            "RESILIENCE_CIRCUIT_CLOSED",
            "MLDL_TRAINING_STARTED",
            "MLDL_CANDIDATE_READY",
            "MLDL_EVALUATED",
            "MLDL_DEPLOYMENT_REQUESTED",
            "MLDL_DEPLOYED",
            "ADV_TEST_FAILED",
            "ANOMALY_DETECTED",
            "IMMUNE_SANDBOXED",
            "IMMUNE_HARDENED",
            "IMMUNE_ROLLED_BACK",
            "TRUST_UPDATED",
            "SNAPSHOT_EXPORTED",
            "ROLLBACK_REQUESTED",
            "ROLLBACK_COMPLETED"
          ],
          "description": "Type of event being transmitted"
        },
        "priority": {
          "type": "string",
          "enum": ["critical", "high", "normal", "low"],
          "default": "normal",
          "description": "Message priority for routing"
        },
        "rbac": {
          "type": "object",
          "properties": {
            "user_id": { "type": "string" },
            "roles": { "type": "array", "items": { "type": "string" } },
            "permissions": { "type": "array", "items": { "type": "string" } }
          },
          "description": "Role-based access control context"
        },
        "pii_flags": {
          "type": "object", 
          "properties": {
            "contains_pii": { "type": "boolean" },
            "pii_types": { "type": "array", "items": { "type": "string" } },
            "redaction_level": { "type": "string", "enum": ["none", "mask", "hash", "remove"] }
          },
          "description": "PII handling flags"
        },
        "consent_scope": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Consent scopes required for this message"
        }
      },
      "required": ["source", "event_type"],
      "additionalProperties": true
    },
    "payload": {
      "type": "object",
      "description": "Event-specific payload data",
      "additionalProperties": true
    },
    "idempotency_key": {
      "type": "string",
      "pattern": "^idem_[a-z0-9]{8,}$",
      "description": "Key for ensuring idempotent processing"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when message was created"
    },
    "retry_count": {
      "type": "integer",
      "minimum": 0,
      "default": 0,
      "description": "Number of times this message has been retried"
    },
    "ttl_seconds": {
      "type": "integer",
      "minimum": 1,
      "default": 3600,
      "description": "Time to live in seconds"
    },
    "schema_version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "default": "1.0.0",
      "description": "GME schema version"
    }
  },
  "required": ["msg_id", "headers", "payload", "idempotency_key", "timestamp"],
  "additionalProperties": false
}