{
  "$id": "grace://comms/experience.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Comms Experience (for MLT)",
  "description": "Communication system experience data for meta-learning optimization",
  "type": "object",
  "required": ["exp_id","stage","metrics","timestamp"],
  "properties": {
    "exp_id": { 
      "type": "string",
      "pattern": "^exp_[a-z0-9]{12}$"
    },
    "stage": { 
      "enum": ["send","deliver","handle","retry","dlq"],
      "description": "Communication stage where experience was captured"
    },
    "metrics": {
      "type": "object",
      "properties": {
        "throughput_rps": { 
          "type": "number", 
          "minimum": 0,
          "description": "Messages per second throughput"
        },
        "p95_end_to_end_ms": { 
          "type": "number", 
          "minimum": 0,
          "description": "95th percentile end-to-end latency"
        },
        "error_rate": { 
          "type": "number", 
          "minimum": 0, 
          "maximum": 1,
          "description": "Error rate as decimal (0.05 = 5%)"
        },
        "retry_rate": { 
          "type": "number", 
          "minimum": 0, 
          "maximum": 1,
          "description": "Retry rate as decimal"
        },
        "dlq_rate": { 
          "type": "number", 
          "minimum": 0, 
          "maximum": 1,
          "description": "Dead letter queue rate as decimal"
        },
        "avg_payload_bytes": { 
          "type": "number", 
          "minimum": 0,
          "description": "Average payload size in bytes"
        },
        "compress_ratio": { 
          "type": "number", 
          "minimum": 0,
          "description": "Compression ratio (compressed/original)"
        },
        "queue_depth": {
          "type": "integer",
          "minimum": 0,
          "description": "Current queue depth"
        },
        "consumer_lag": {
          "type": "integer", 
          "minimum": 0,
          "description": "Consumer lag in messages"
        }
      },
      "additionalProperties": true
    },
    "context": {
      "type": "object",
      "properties": {
        "transport": { "enum": ["kafka","nats","amqp","http","ws"] },
        "lane": { "type": "string", "pattern": "^lane\\.(P[0-3])$" },
        "domain": { "type": "string" },
        "qos_class": { "enum": ["realtime","standard","bulk"] },
        "batch_size": { "type": "integer", "minimum": 1 },
        "compression_codec": { "enum": ["none","gzip","zstd"] },
        "partition_count": { "type": "integer", "minimum": 1 },
        "consumer_count": { "type": "integer", "minimum": 0 }
      }
    },
    "labels": { 
      "type": "object", 
      "description": "Categorical labels for grouping experiences",
      "properties": {
        "lane": { "type": "string" },
        "domain": { "type": "string" },
        "transport": { "type": "string" },
        "priority": { "enum": ["P0","P1","P2","P3"] }
      },
      "additionalProperties": true
    },
    "timestamp": { 
      "type": "string", 
      "format": "date-time",
      "description": "When this experience was captured"
    },
    "correlation_id": {
      "type": "string",
      "pattern": "^cor_[a-z0-9_-]{6,}$",
      "description": "Links this experience to a communication flow"
    }
  },
  "additionalProperties": false
}