{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://grace.ai/schemas/ml-contracts/v1",
  "title": "Grace ML Contracts",
  "description": "JSON Schema definitions for Grace ML system contracts",

  "$defs": {
    "SemVer": {
      "type": "string", 
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
    },
    "UID": {
      "type": "string", 
      "pattern": "^[a-z][a-z0-9_-]{4,64}$"
    },
    "ISO8601": {
      "type": "string", 
      "format": "date-time"
    },
    "Sha256": {
      "type": "string", 
      "pattern": "^sha256:[a-f0-9]{64}$"
    }
  },

  "Task": {
    "enum": ["classification", "regression", "clustering", "dimred", "rl"]
  },

  "Metric": {
    "classification": ["accuracy", "f1", "auroc", "logloss", "calibration"],
    "regression": ["rmse", "mae", "r2", "mape"],
    "clustering": ["silhouette", "davies_bouldin"],
    "dimred": ["explained_variance"],
    "rl": ["episode_return", "stability"]
  },

  "SpecialistReport": {
    "type": "object",
    "required": ["report_id", "specialist", "task", "candidates", "timestamp", "version"],
    "properties": {
      "report_id": {"$ref": "#/$defs/UID"},
      "specialist": {
        "type": "string",
        "description": "e.g., Tabular-Classification"
      },
      "task": {"$ref": "#/Task"},
      "candidates": {
        "type": "array",
        "items": {
          "type": "object",
          "required": ["model_key", "version", "artifact_uri", "metrics"],
          "properties": {
            "model_key": {
              "type": "string",
              "description": "e.g., tabular.classification.xgb"
            },
            "version": {"$ref": "#/$defs/SemVer"},
            "artifact_uri": {"type": "string"},
            "metrics": {
              "type": "object",
              "description": "by task; see Metric enum"
            },
            "risks": {
              "type": "array",
              "items": {"type": "string"}
            },
            "explanations": {
              "type": "object",
              "description": "SHAP/feature importances etc."
            },
            "validation_hash": {"$ref": "#/$defs/Sha256"}
          }
        }
      },
      "dataset_id": {"type": "string"},
      "notes": {"type": "string"},
      "timestamp": {"$ref": "#/$defs/ISO8601"},
      "version": {"$ref": "#/$defs/SemVer"}
    }
  },

  "Experience": {
    "type": "object",
    "required": ["experience_id", "source", "task", "context", "signals", "timestamp"],
    "properties": {
      "experience_id": {"$ref": "#/$defs/UID"},
      "source": {
        "enum": ["training", "inference", "governance", "ops"]
      },
      "task": {"$ref": "#/Task"},
      "context": {
        "type": "object",
        "properties": {
          "dataset_id": {"type": "string"},
          "model_key": {"type": "string"},
          "model_version": {"$ref": "#/$defs/SemVer"},
          "segment": {"type": "string"},
          "env": {"enum": ["dev", "staging", "prod"]}
        }
      },
      "signals": {
        "type": "object",
        "properties": {
          "metrics": {"type": "object"},
          "drift": {
            "type": "object",
            "properties": {
              "psi": {"type": "number"},
              "kl": {"type": "number"},
              "mmd": {"type": "number"}
            }
          },
          "fairness": {
            "type": "object",
            "properties": {
              "delta": {"type": "number"},
              "groups": {
                "type": "array",
                "items": {"type": "string"}
              }
            }
          },
          "latency": {
            "type": "object",
            "properties": {
              "p95_ms": {"type": "number"}
            }
          },
          "compliance": {
            "type": "object",
            "properties": {
              "constitutional": {"type": "number"}
            }
          }
        }
      },
      "ground_truth_lag_s": {
        "type": "integer",
        "minimum": 0
      },
      "timestamp": {"$ref": "#/$defs/ISO8601"}
    }
  },

  "Insight": {
    "type": "object",
    "required": ["insight_id", "type", "scope", "evidence", "confidence", "timestamp"],
    "properties": {
      "insight_id": {"$ref": "#/$defs/UID"},
      "type": {
        "enum": ["performance", "drift", "fairness", "calibration", "stability", "governance_alignment"]
      },
      "scope": {
        "enum": ["model", "specialist", "policy", "dataset", "segment"]
      },
      "target_ref": {
        "type": "string",
        "description": "e.g., model_key or policy path"
      },
      "evidence": {
        "type": "object",
        "description": "before/after stats, tests run"
      },
      "confidence": {
        "type": "number",
        "minimum": 0,
        "maximum": 1
      },
      "recommendation": {
        "enum": ["retrain", "reweight", "recalibrate", "hpo", "policy_tune", "segment_route"]
      },
      "timestamp": {"$ref": "#/$defs/ISO8601"}
    }
  },

  "AdaptationPlan": {
    "type": "object",
    "required": ["plan_id", "actions", "expected_effect", "risk_controls", "created_at", "version"],
    "properties": {
      "plan_id": {"$ref": "#/$defs/UID"},
      "actions": {
        "type": "array",
        "minItems": 1,
        "items": {
          "oneOf": [
            {
              "type": "object",
              "required": ["type", "target", "budget", "success_metric"],
              "properties": {
                "type": {"const": "hpo"},
                "target": {
                  "type": "string",
                  "description": "family or model_key"
                },
                "budget": {
                  "type": "object",
                  "properties": {
                    "trials": {"type": "integer"},
                    "max_runtime_min": {"type": "integer"}
                  }
                },
                "success_metric": {"type": "string"}
              }
            },
            {
              "type": "object",
              "required": ["type", "weights"],
              "properties": {
                "type": {"const": "reweight_specialists"},
                "weights": {
                  "type": "object",
                  "additionalProperties": {"type": "number"},
                  "description": "{Fairness:1.05}"
                }
              }
            },
            {
              "type": "object",
              "required": ["type", "path", "from", "to"],
              "properties": {
                "type": {"const": "policy_delta"},
                "path": {
                  "type": "string",
                  "description": "e.g., governance.thresholds.min_calibration"
                },
                "from": {},
                "to": {}
              }
            },
            {
              "type": "object",
              "required": ["type", "target_model", "steps"],
              "properties": {
                "type": {"const": "canary"},
                "target_model": {"type": "string"},
                "steps": {
                  "type": "array",
                  "items": {"type": "integer"}
                }
              }
            }
          ]
        }
      },
      "expected_effect": {
        "type": "object",
        "description": "e.g., {f1:\"+1.2%\", calibration:\"+0.02\"}"
      },
      "risk_controls": {
        "type": "object",
        "properties": {
          "max_regret_pct": {"type": "number"},
          "halt_on_drift_z": {"type": "number"}
        }
      },
      "created_at": {"$ref": "#/$defs/ISO8601"},
      "version": {"$ref": "#/$defs/SemVer"}
    }
  },

  "GovernanceSnapshot": {
    "type": "object",
    "required": ["snapshot_id", "instance_id", "version", "policies", "thresholds", "model_weights", "state_hash", "created_at"],
    "properties": {
      "snapshot_id": {"$ref": "#/$defs/UID"},
      "instance_id": {"$ref": "#/$defs/UID"},
      "version": {"$ref": "#/$defs/SemVer"},
      "policies": {"type": "object"},
      "thresholds": {
        "type": "object",
        "description": "e.g., {min_conf:0.78, min_trust:0.72}"
      },
      "model_weights": {
        "type": "object",
        "description": "specialist weights"
      },
      "state_hash": {"$ref": "#/$defs/Sha256"},
      "created_at": {"$ref": "#/$defs/ISO8601"}
    }
  },

  "MLTSnapshot": {
    "type": "object",
    "required": ["snapshot_id", "planner_version", "search_spaces", "weights", "policies", "active_jobs", "hash"],
    "properties": {
      "snapshot_id": {"$ref": "#/$defs/UID"},
      "planner_version": {"$ref": "#/$defs/SemVer"},
      "search_spaces": {"type": "object"},
      "weights": {"type": "object"},
      "policies": {"type": "object"},
      "active_jobs": {"type": "array"},
      "hash": {"$ref": "#/$defs/Sha256"}
    }
  }
}